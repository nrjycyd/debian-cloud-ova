name: ğŸš€ Build & Release Debian OVA

on:
  # ç§»é™¤ push: branches è§¦å‘ï¼Œä»…ä½¿ç”¨æ‰‹åŠ¨è§¦å‘æ¥æ§åˆ¶ç‰ˆæœ¬å’Œ Release
  # å¦‚æœéœ€è¦æ¯æ¬¡ push éƒ½è§¦å‘æ„å»ºï¼Œå¯ä»¥ä¿ç•™ push: branchesï¼Œä½†éœ€è°ƒæ•´ Release æ­¥éª¤çš„é€»è¾‘ã€‚
  # ç°æ”¹ä¸ºåªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œï¼š
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version/Codename to build (e.g., bookworm, 12, trixie)'
        required: true
        default: 'bookworm'
      release_tag: # æ–°å¢ä¸€ä¸ªè¾“å…¥å­—æ®µï¼Œç”¨äºæŒ‡å®š Release çš„ç‰ˆæœ¬æ ‡ç­¾
        description: 'The Git Tag (e.g., v1.0.0) for the Release (Required)'
        required: true
        default: 'v1.0.0'

jobs:
  build_ova:
    runs-on: ubuntu-latest
    
    env:
      TARGET_VERSION: ${{ github.event.inputs.debian_version }}
      RELEASE_TAG: ${{ github.event.inputs.release_tag }}
      #SCRIPT_URL: https://raw.githubusercontent.com/burbuja/debian-ova-creator/master/debian-ova-creator.sh
      SCRIPT_URL: https://raw.githubusercontent.com/nrjycyd/debian-cloud/refs/heads/main/.github/workflows/debian-ova-creator-test.sh
      SCRIPT_NAME: debian-ova-creator.sh

    steps:
      - name: 1. Checkout Repository Code
        uses: actions/checkout@v4
        
      - name: 2. Install Dependencies (wget & qemu-utils)
        run: |
          echo "Updating system packages and installing dependencies..."
          sudo apt update
          sudo apt install -y wget qemu-utils

      - name: 3. â¬‡ï¸ Download and Prepare Script
        run: |
          echo "Downloading script from $SCRIPT_URL"
          wget "$SCRIPT_URL" -O "$SCRIPT_NAME"
          chmod +x "$SCRIPT_NAME"

      - name: 4. âš™ï¸ Run OVA Creation Script
        id: run_script
        run: |
          echo "Starting build for Debian version: $TARGET_VERSION"
          # æ‰§è¡Œä¸‹è½½å¹¶æˆæƒåçš„è„šæœ¬
          ./"$SCRIPT_NAME" -d "$TARGET_VERSION"
          
          # è·å–ç”Ÿæˆçš„ OVA æ–‡ä»¶å
          FILE_NAME=$(ls debian-*-genericcloud-amd64.ova)
          echo "Generated OVA file: $FILE_NAME"
          echo "OVA_FILE_NAME=$FILE_NAME" >> $GITHUB_OUTPUT

      # --- å…³é”®æ›´æ”¹åœ¨è¿™é‡Œï¼šä½¿ç”¨ softprops/action-gh-release ---
      - name: 5. ğŸš€ Create GitHub Release and Upload OVA
        # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œæ­¤æ­¥éª¤
        if: github.event_name == 'workflow_dispatch' 
        uses: softprops/action-gh-release@v2
        with:
          # files: æŒ‡å®šè¦ä¸Šä¼ åˆ° Release çš„æ–‡ä»¶è·¯å¾„
          files: ${{ steps.run_script.outputs.OVA_FILE_NAME }}
          # tag_name: ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ Tag åç§°
          tag_name: ${{ env.RELEASE_TAG }}
          # name: Release åœ¨ GitHub é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜
          name: Debian ${{ env.TARGET_VERSION }} OVA - ${{ env.RELEASE_TAG }}
          # body: Release æè¿°å†…å®¹
          body: |
            ## ğŸ‰ Debian Cloud Image OVA for ${{ env.TARGET_VERSION }}
            
            This OVA was automatically built using the script from ${{ env.SCRIPT_URL }}.
            
            - **OVA Asset:** ${{ steps.run_script.outputs.OVA_FILE_NAME }}
            
          # generate_release_notes: true å°†è‡ªåŠ¨ç”Ÿæˆ Release Notes
          draft: false
          prerelease: false
          
        env:
          # å¿…é¡»æä¾› GITHUB_TOKENï¼Œç”¨äºæˆæƒåˆ›å»º Release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 6. Clean up (Optional)
        if: always()
        run: |
          echo "Build finished. Cleaning up intermediate files..."
          rm -f *.qcow2 *.ovf *.mf
