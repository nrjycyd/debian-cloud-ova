name: ðŸš€ Build & Release Debian OVA

on:
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version/Codename (e.g., bookworm, 12, trixie, bullseye, 11, 13, sid)'
        required: true
        default: 'bookworm'
      vcpu:
        description: 'Number of vCPU (default: 2)'
        required: false
        default: '2'
      memory:
        description: 'Memory size in MB (default: 1024)'
        required: false
        default: '1024'
      disk_size:
        description: 'Disk size in GB (default: 10)'
        required: false
        default: '10'
      hostname:
        description: 'Hostname (default: debian-cloud)'
        required: false
        default: 'debian-cloud'
      username:
        description: 'Default username (default: debian)'
        required: false
        default: 'debian'
      password:
        description: 'User password (default: 123456)'
        required: false
        default: '123456'
      release_tag:
        description: 'Git Tag for Release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build_ova:
    runs-on: ubuntu-latest
    
    env:
      TARGET_VERSION: ${{ github.event.inputs.debian_version }}
      TARGET_VCPU: ${{ github.event.inputs.vcpu }}
      TARGET_MEMORY: ${{ github.event.inputs.memory }}
      TARGET_DISK: ${{ github.event.inputs.disk_size }}
      TARGET_HOSTNAME: ${{ github.event.inputs.hostname }}
      TARGET_USERNAME: ${{ github.event.inputs.username }}
      TARGET_PASSWORD: ${{ github.event.inputs.password }}
      RELEASE_TAG: ${{ github.event.inputs.release_tag }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "Installing dependencies..."
          sudo apt update -qq
          sudo apt install -y wget qemu-utils whois
          echo "âœ… Dependencies installed"

      - name: ðŸ”¨ Build OVA
        id: build
        run: |
          chmod +x ./debian-ova-creator.sh
          
          echo "Starting OVA build with parameters:"
          echo "  Debian Version: ${{ env.TARGET_VERSION }}"
          echo "  vCPU: ${{ env.TARGET_VCPU }}"
          echo "  Memory: ${{ env.TARGET_MEMORY }}MB"
          echo "  Disk: ${{ env.TARGET_DISK }}GB"
          echo "  Hostname: ${{ env.TARGET_HOSTNAME }}"
          echo "  Username: ${{ env.TARGET_USERNAME }}"
          
          ./debian-ova-creator.sh \
            -d "${{ env.TARGET_VERSION }}" \
            -c "${{ env.TARGET_VCPU }}" \
            -m "${{ env.TARGET_MEMORY }}" \
            -s "${{ env.TARGET_DISK }}" \
            -H "${{ env.TARGET_HOSTNAME }}" \
            -u "${{ env.TARGET_USERNAME }}" \
            -p "${{ env.TARGET_PASSWORD }}"
          
          # Get generated OVA file
          FILE_NAME=$(ls debian-*-genericcloud-amd64*.ova 2>/dev/null | head -1)
          if [ -z "$FILE_NAME" ]; then
              echo "âŒ Error: OVA file not found"
              ls -la
              exit 1
          fi
          
          FILE_SIZE=$(du -h "$FILE_NAME" | cut -f1)
          echo "âœ… Build completed: $FILE_NAME ($FILE_SIZE)"
          
          echo "OVA_FILE_NAME=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "OVA_FILE_SIZE=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build.outputs.OVA_FILE_NAME }}
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Debian ${{ env.TARGET_VERSION }} OVA - ${{ env.RELEASE_TAG }}"
          body: |
            ## ðŸŽ‰ Debian Cloud Image OVA
            
            **Build Configuration:**
            - Debian Version: **${{ env.TARGET_VERSION }}**
            - vCPU: **${{ env.TARGET_VCPU }}**
            - Memory: **${{ env.TARGET_MEMORY }}MB**
            - Disk Size: **${{ env.TARGET_DISK }}GB**
            - Hostname: **${{ env.TARGET_HOSTNAME }}**
            - Default User: **${{ env.TARGET_USERNAME }}**
            - File Size: **${{ steps.build.outputs.OVA_FILE_SIZE }}**
            - Built: **$(date -u +'%Y-%m-%d %H:%M:%S UTC')**
            
            **Quick Start:**
            1. Download the OVA file from assets
            2. Import into VMware or compatible hypervisor
            3. Power on and login with credentials:
               - Username: `${{ env.TARGET_USERNAME }}`
               - Password: `${{ env.TARGET_PASSWORD }}`
            
            **Cloud-Init Support:**
            - Custom hostname configuration
            - User account creation with sudo access
            - SSH key injection (if provided)
            - User-data script execution
            
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      Debian OVA Build Complete         â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Version: ${{ env.TARGET_VERSION }}"
          echo "â•‘ vCPU: ${{ env.TARGET_VCPU }}"
          echo "â•‘ Memory: ${{ env.TARGET_MEMORY }}MB"
          echo "â•‘ Disk: ${{ env.TARGET_DISK }}GB"
          echo "â•‘ Hostname: ${{ env.TARGET_HOSTNAME }}"
          echo "â•‘ Username: ${{ env.TARGET_USERNAME }}"
          echo "â•‘ Tag: ${{ env.RELEASE_TAG }}"
          if [ -n "${{ steps.build.outputs.OVA_FILE_NAME }}" ]; then
            echo "â•‘ File: ${{ steps.build.outputs.OVA_FILE_NAME }}"
            echo "â•‘ Size: ${{ steps.build.outputs.OVA_FILE_SIZE }}"
          fi
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f *.qcow2 *.vmdk *.ovf *.mf *.ova 2>/dev/null || true
          echo "âœ… Cleanup completed"
