name: ğŸš€ Build Debian Cloud Image OVA from GitHub URL

on:
  # è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  push:
    branches:
      - master
      - main
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debian_version:
        description: 'Debian Version/Codename to build (e.g., bookworm, 12, trixie)'
        required: true
        default: 'bookworm'

jobs:
  build_ova:
    runs-on: ubuntu-latest
    
    env:
      TARGET_VERSION: ${{ github.event.inputs.debian_version || 'bookworm' }}
      # è„šæœ¬çš„ Raw URLï¼Œç”¨äºç›´æ¥ä¸‹è½½æ–‡ä»¶å†…å®¹
      SCRIPT_URL: https://raw.githubusercontent.com/burbuja/debian-ova-creator/master/debian-ova-creator.sh
      SCRIPT_NAME: debian-ova-creator.sh # è„šæœ¬çš„æ–‡ä»¶å

    steps:
      - name: 1. Checkout Repository Code
        # è™½ç„¶æˆ‘ä»¬è¦ä¸‹è½½å¤–éƒ¨è„šæœ¬ï¼Œä½†æœ€å¥½è¿˜æ˜¯æ£€å‡ºä»“åº“ï¼Œä»¥ä¾¿ä¸Šä¼  Artifact
        uses: actions/checkout@v4
        
      - name: 2. Install Dependencies (wget & qemu-utils)
        run: |
          echo "Updating system packages and installing dependencies..."
          sudo apt update
          sudo apt install -y wget qemu-utils

      - name: 3. â¬‡ï¸ Download and Prepare Script
        run: |
          echo "Downloading script from $SCRIPT_URL"
          # ä½¿ç”¨ wget ä¸‹è½½è„šæœ¬åˆ°å½“å‰å·¥ä½œç›®å½•
          wget "$SCRIPT_URL" -O "$SCRIPT_NAME"
          # èµ‹äºˆæ‰§è¡Œæƒé™ï¼Œè§£å†³ä¹‹å‰é‡åˆ°çš„ "No such file or directory" é”™è¯¯
          chmod +x "$SCRIPT_NAME"

      - name: 4. âš™ï¸ Run OVA Creation Script
        id: run_script
        run: |
          echo "Starting build for Debian version: $TARGET_VERSION"
          # æ‰§è¡Œä¸‹è½½å¹¶æˆæƒåçš„è„šæœ¬
          ./"$SCRIPT_NAME" -d "$TARGET_VERSION"
          
          # è·å–ç”Ÿæˆçš„ OVA æ–‡ä»¶åï¼ˆä¾‹å¦‚ debian-12-genericcloud-amd64.ovaï¼‰
          FILE_NAME=$(ls debian-*-genericcloud-amd64.ova)
          echo "Generated OVA file: $FILE_NAME"
          # å°†æ–‡ä»¶åè®¾ç½®ä¸ºè¾“å‡ºå˜é‡ï¼Œä¾›ä¸‹ä¸€æ­¥ä¸Šä¼  Artifact ä½¿ç”¨
          echo "OVA_FILE_NAME=$FILE_NAME" >> $GITHUB_OUTPUT

      # --- å…³é”®æ›´æ”¹åœ¨è¿™é‡Œï¼ ---
      - name: 5. ğŸš€ Create GitHub Release and Upload OVA
        # ä»…åœ¨ Git Tag æ¨é€è§¦å‘æ—¶æ‰§è¡Œæ­¤æ­¥éª¤ã€‚
        # github.ref_name æ˜¯ Tag åç§° (ä¾‹å¦‚: v1.0.0)ã€‚
        if: startsWith(github.ref, 'refs/tags/') 
        uses: softprops/action-gh-release@v2
        with:
          # files: æŒ‡å®šè¦ä¸Šä¼ åˆ° Release çš„æ–‡ä»¶è·¯å¾„
          files: ${{ steps.run_script.outputs.OVA_FILE_NAME }}
          # tag_name: ä½¿ç”¨æ¨é€çš„ Tag åç§°ä½œä¸º Release åç§°
          tag_name: ${{ github.ref_name }}
          # name: Release åœ¨ GitHub é¡µé¢ä¸Šæ˜¾ç¤ºçš„æ ‡é¢˜
          name: Debian ${{ env.TARGET_VERSION }} OVA ${{ github.ref_name }}
          # body: Release æè¿°å†…å®¹
          body: |
            ## ğŸ‰ Debian Cloud Image OVA for ${{ env.TARGET_VERSION }}
            
            This artifact was automatically built using the script from ${{ env.SCRIPT_URL }}.
            
            - **OVA Asset:** ${{ steps.run_script.outputs.OVA_FILE_NAME }}
            
          # GITHUB_TOKEN æ˜¯ç”± GitHub è‡ªåŠ¨æä¾›å¹¶å…·æœ‰ Release åˆ›å»ºæƒé™çš„ secret
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 6. Clean up (Optional)
        if: always()
        run: |
          echo "Build finished. Cleaning up intermediate files..."
          rm -f *.qcow2 *.ovf *.mf
